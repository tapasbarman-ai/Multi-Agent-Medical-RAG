<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical AI Assistant</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="app-container">
        <!-- Left Sidebar Navigation -->
        <div class="nav-sidebar">
            <div class="nav-item active" title="Chat">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
            </div>
            <!-- Removed unused icons: History, Settings, Resources, Appointments -->
        </div>

        <!-- Chat Sidebar -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <div class="workspace-selector">
                    <span class="workspace-text">Medical AI Assistant</span>
                    <svg class="dropdown-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9" />
                    </svg>
                </div>
            </div>

            <button class="new-chat-btn" onclick="newChat()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                <span>New Chat</span>
            </button>

            <div class="search-container">
                <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.35-4.35" />
                </svg>
                <input type="text" placeholder="Search chats..." class="search-input">
            </div>

            <div class="chat-list" id="chatList">
                <div class="chat-list-empty">
                    <em>No chats.</em>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="collapse-btn" onclick="toggleSidebar()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12" />
                            <line x1="3" y1="6" x2="21" y2="6" />
                            <line x1="3" y1="18" x2="21" y2="18" />
                        </svg>
                    </button>
                    <div class="model-selector" style="cursor: default;">
                        <span class="model-name">Medical Coordinator</span>
                        <!-- Removed dropdown icon since there's no selection -->
                    </div>
                </div>
                <div class="top-bar-right">
                    <button class="icon-btn" onclick="toggleTheme()" id="themeToggle" title="Toggle theme">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area" id="chatArea">
                <div class="welcome-screen">
                    <div class="welcome-icon">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                        </svg>
                    </div>
                    <h1>Medical AI Assistant</h1>
                    <p>Ask me about symptoms, diseases, treatments, or the latest medical research</p>

                    <div class="suggestion-cards">
                        <div class="suggestion-card" onclick="askSample('What are the symptoms of diabetes?')">
                            <div class="suggestion-icon">üíä</div>
                            <div class="suggestion-text">What are the symptoms of diabetes?</div>
                        </div>
                        <div class="suggestion-card" onclick="askSample('Latest research on heart disease')">
                            <div class="suggestion-icon">üî¨</div>
                            <div class="suggestion-text">Latest research on heart disease</div>
                        </div>
                        <div class="suggestion-card" onclick="askSample('Cancer treatment options and studies')">
                            <div class="suggestion-icon">üìä</div>
                            <div class="suggestion-text">Cancer treatment options and studies</div>
                        </div>
                        <div class="suggestion-card" onclick="askSample('What causes high blood pressure?')">
                            <div class="suggestion-icon">‚ù§Ô∏è</div>
                            <div class="suggestion-text">What causes high blood pressure?</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-section">
                <div class="input-wrapper">
                    <!-- Removed attachment button -->
                    <textarea class="message-input" id="messageInput" placeholder="Send a message..." rows="1"
                        onkeydown="handleKeyPress(event)"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13" />
                            <polygon points="22 2 15 22 11 13 2 9 22 2" />
                        </svg>
                    </button>
                </div>
                <div class="input-footer">
                    <span class="disclaimer-text">‚ö†Ô∏è For informational purposes only. Consult healthcare professionals
                        for medical advice.</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Marked.js for better formatting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        let currentChatId = null;
        let isTyping = false;
        const API_URL = window.location.origin;

        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadChatHistory();
            newChat();
            setupAutoResize();
        });

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }

        function loadTheme() {
            const theme = localStorage.getItem('theme');
            if (theme === 'light') {
                document.body.classList.add('light-mode');
            }
        }

        function toggleSidebar() {
            document.querySelector('.chat-sidebar').classList.toggle('collapsed');
        }

        function newChat() {
            currentChatId = Date.now().toString();
            clearChatDisplay();
            saveChatToHistory();
            updateChatList();
        }

        function clearChatDisplay() {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '';
        }

        function addMessage(text, isUser, toolUsed = null) {
            const chatArea = document.getElementById('chatArea');

            const welcomeScreen = chatArea.querySelector('.welcome-screen');
            if (welcomeScreen) {
                welcomeScreen.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

            // Tool Badge for Bot
            let toolBadge = '';
            if (!isUser && toolUsed && toolUsed !== 'unknown') {
                const toolNames = {
                    'rag': 'üìö Knowledge Base',
                    'research': 'üî¨ Research Papers',
                    'websearch': 'üåê Web Search',
                    'multi': '‚ú® Multi-Source',
                    'safety': 'üõ°Ô∏è Safety'
                };
                const toolName = toolNames[toolUsed] || toolUsed;
                toolBadge = `<div class="tool-badge">${toolName}</div>`;
            }

            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${isUser ?
                    '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>' :
                    '<div class="bot-icon">UI</div>'
                }
                </div>
                <div class="message-content">
                    ${toolBadge}
                    <div class="markdown-body">${formatMessage(text)}</div>
                </div>
            `;

            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;

            // Only save if it's a new message (not loading history)
            // But here we are just adding to UI. Saving happens in sendMessage loop or manually.
            // The logic was slightly mixed before. Let's keep it simple.
        }

        function formatMessage(text) {
            // Use marked.js if available, otherwise fallback
            if (typeof marked !== 'undefined') {
                return marked.parse(text);
            }
            return text.replace(/\n/g, '<br>');
        }

        function showTypingIndicator() {
            const chatArea = document.getElementById('chatArea');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar"><div class="bot-icon">UI</div></div>
                <div class="message-content">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>`;
            chatArea.appendChild(typingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || isTyping) return;

            // 1. Show User Message
            addMessage(message, true);
            input.value = '';
            input.style.height = 'auto';

            isTyping = true;
            document.getElementById('sendBtn').disabled = true;
            input.disabled = true;
            showTypingIndicator();

            try {
                // 2. Send to Backend
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: message,
                        chat_id: currentChatId
                    })
                });

                const data = await response.json();
                removeTypingIndicator();

                // 3. Show Bot Response with Tool Info
                addMessage(data.answer || 'Sorry, I encountered an error.', false, data.tool_used);

                // Update history title if needed
                updateChatList();

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
                addMessage('‚ö†Ô∏è Could not connect to server.', false);
            } finally {
                isTyping = false;
                document.getElementById('sendBtn').disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function askSample(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }

        async function saveChatToHistory() {
            try {
                await fetch(`${API_URL}/chats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: currentChatId, title: 'New Chat' })
                });
            } catch (error) { console.error('Error saving chat:', error); }
        }

        async function loadChatHistory() {
            await updateChatList();
        }

        async function updateChatList() {
            const chatList = document.getElementById('chatList');
            try {
                const response = await fetch(`${API_URL}/chats`);
                const data = await response.json();
                const chats = data.chats || [];

                if (chats.length === 0) {
                    chatList.innerHTML = '<div class="chat-list-empty"><em>No chats.</em></div>';
                    return;
                }

                chatList.innerHTML = '';
                chats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                    // Important: prevent delete button click from triggering loadChat
                    item.onclick = (e) => {
                        if (!e.target.closest('.delete-chat-btn')) {
                            loadChat(chat.id);
                        }
                    };

                    item.innerHTML = `
                        <div class="chat-item-content">
                            <div class="chat-item-title">${chat.title}</div>
                            <div class="chat-item-time">${formatTime(chat.updated_at || chat.created_at)}</div>
                        </div>
                        <button class="delete-chat-btn" onclick="deleteChat('${chat.id}')" title="Delete Chat">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    `;
                    chatList.appendChild(item);
                });

            } catch (error) { console.error('Error loading chats:', error); }
        }

        async function loadChat(chatId) {
            currentChatId = chatId;
            try {
                const response = await fetch(`${API_URL}/chats/${chatId}`);
                const data = await response.json();

                if (data.chat && data.messages) {
                    clearChatDisplay();
                    data.messages.forEach(msg => {
                        // Tool info isn't stored in basic DB schema currently, so we pass null on reload
                        // (Future improvement: store tool_used in DB)
                        addMessage(msg.message, msg.is_user);
                    });
                    updateChatList();
                }
            } catch (error) { console.error('Error loading chat:', error); }
        }

        async function deleteChat(chatId) {
            if (!confirm('Are you sure you want to delete this chat?')) return;

            try {
                await fetch(`${API_URL}/chats/${chatId}`, { method: 'DELETE' });
                if (currentChatId === chatId) {
                    newChat();
                } else {
                    updateChatList();
                }
            } catch (error) { console.error('Error deleting chat:', error); }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            return date.toLocaleDateString();
        }

        function setupAutoResize() {
            const input = document.getElementById('messageInput');
            input.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });
        }
    </script>
</body>

</html>